---
title: "Dispute Resolution: Exploratory Analysis"
output: html_notebook
---

# Initial Questions 

- Are there any interesting patterns in variation in any of the variables?  
- What proportion of each dispute total category does each state represent?  
- Is there a relationship betweent he population of a state and the number of dispute totals?  

```{r}
library(tidyverse, verbose = T)
library(stringr, verbose = T)
library(maps)
```

First, we'll read in the data and combine the 2012 through 2015 datasets into one dataframe. For now, we won't `gather` up the variables so that we can explore the variation in each variable. 

```{r read files}
fnames <- c(
  "https://www2.ed.gov/programs/osepidea/618-data/state-level-data-files/part-b-data/dispute-resolution/bdispres2014-15.csv",
  "https://www2.ed.gov/programs/osepidea/618-data/state-level-data-files/part-b-data/dispute-resolution/bdispres2013-14.csv", 
  "https://www2.ed.gov/programs/osepidea/618-data/state-level-data-files/part-b-data/dispute-resolution/bdispres2012-13.csv"#,
  
  # Having trouble reading in the first row with these.
  #"https://www2.ed.gov/programs/osepidea/618-data/state-level-data-files/part-b-data/dispute-resolution/bdispres2011-12.csv",
  #"https://www2.ed.gov/programs/osepidea/618-data/state-level-data-files/part-b-data/dispute-resolution/bdispres2010-11.csv"
)

# Read files
allfiles <- lapply(fnames, function(x) {read_csv(
  x, 
  skip = 4, 
  col_types = cols(Year = col_character()), 
  n_max = 61
  )})

# Combine
comb <- bind_rows(allfiles)
```

Let's clean up the variable names so they are a little more readable. They are still a little long, but we can at least remove the codes and parenthesis that are in the original datasets. 

```{r}
cnames <- names(comb) %>% 
  str_replace_all("\\(", "") %>% 
  str_replace_all("\\)", "") 

for (i in 3:length(cnames)) {
 str_sub(
  cnames[i],
  str_locate(cnames[i], regex("[0-9]"))[1, 1], 
  str_length(cnames[i])
  ) <- ""
}

cnames <- str_trim(cnames, "right")

names(comb) <- cnames
```

We'll also clean up our state names to all lower case to make it easier to plot our map later in the analysis. 

```{r}
comb$State <- tolower(comb$State)
```

Let's verify that we have usable classes for each of the variables. 

```{r}
str(comb)
```

Here are the counts for the number of observations in each year: 

```{r}
count(comb, Year)
```

There are some really strange values, which might indicate some data errors on the high end. 

```{r}
comb1415 <- comb %>% filter(Year == "2014-2015")
sapply(comb1415[, 3:length(names(comb1415))], function(x) {range(x)})
```

Let's gather up the variables into one category for just the 2014-2015 year so we can explore the variation in each one. 

```{r}
g_comb1415 <- comb %>% 
  filter(Year == "2014-2015") %>%
  gather(category, total, -c(Year, State))
```

Let's further explore the strange high values in some of the categories. The 
outliers are so high and so different from the the rest of the value that it 
obscures the boxplots so we're going to zoom in to `total` values of 5000 or less.

For most categories, the median count across all states do not give a good summary of any one state's totals. Most categories have states whose totals are uncharacteristically high for that category. 

```{r}
# TODO Label max values for each category with the state name
ggplot(data = g_comb1415) +
  geom_boxplot(aes(x = reorder(category, total, FUN = max), y = total)) + 
  coord_flip(ylim = c(0, 5000)) + 
  labs(
    title = "Distribution of Category Totals", 
    subtitle = "Data: 2014-2015 Dispute Resolution", 
    x = "", 
    y = ""
    )
```

# How are these totals related to each state's population? 

```{r}
state_pop <- read_csv("state_data/state_pop.csv")
state_pop$State <- tolower(state_pop$State) # Change state names to lower case

g_comb1415 <- left_join(g_comb1415, state_pop, by = c("State" = "State"))
```

I do not have population data for the following regions, so for now we will leave them out and will examine them later. In particular, US, Outlying Areas and Freely Associated States has a sizable amount of category totals.

```{r}
unique(g_comb1415$State[is.na(g_comb1415$Population)])
```

Note here that not all categories suggest a relationship between a state's population and the total count of that category. 

```{r}
ggplot(data = g_comb1415) + 
  geom_point(aes(x = Population, y = total), na.rm = T, alpha = .5) + 
  geom_smooth(aes(x = Population, y = total)) +
  coord_cartesian(ylim = c(0, 1000)) +
  facet_wrap(~ category) + 
  labs(title = "State Population and Category Counts", 
       subtitle = "Data: 2014-2015 Dispute Resolution Data")
```

# Visualizing Totals on a US Map

```{r}
all_states <- map_data("state")
disp_map <- left_join(g_comb1415, all_states, by = c("State" = "region"))
```

Here are how category totals are distributed across states. 

```{r}
ggplot() +
  geom_polygon(data=disp_map, 
               aes(x=long, y=lat), 
               colour="white", 
               na.rm = T) + 
  scale_fill_continuous(low = "thistle2", high = "darkred", guide="colorbar") +
  theme_bw()  + labs(fill = "Some label", title = "Some title", x="", y="")

P1 + scale_y_continuous(breaks=c()) + scale_x_continuous(breaks=c()) + theme(panel.border =  element_blank())
```

First let's plot the variation in each variable.

```{r}
ggplot(data = g_comb1415, aes(x = total)) + 
  geom_histogram(binwidth = 15) +
  facet_wrap(~ category)
```

```{r by state in 14-15}
# Total due process complains in 14-15 by state
by_state_14 <- comb %>%
  filter(
    Year     == "2014-2015", 
    category == "Due Process Complaints (DPC) Total (3)"
    ) %>%
  arrange(desc(total))

ggplot(data = by_state_14, aes(reorder(x = State, total), y = total)) +
  geom_bar(stat = "identity") +
  coord_flip() +
  labs(
    title = "Total Due Process Complaints", 
    subtitle = "2014-2015", 
    x = "State"
    )
```

```{r by state in 13-14}
# Total due process complains in 13-14 by state
by_state_13 <- comb %>%
  filter(
    Year     == "2013-2014", 
    category == "Due Process Complaints (DPC) Total (3)"
    ) %>%
  arrange(desc(total))
```

```{r by state in 12-13}
# Total due process complains in 12-13 by state
by_state_12 <- comb %>%
  filter(
    Year     == "2012-2013", 
    category == "Due Process Complaints (DPC) Total (3)"
    ) %>%
  arrange(desc(total))
```

```{r}
# What is the median number of due process complaints?
p <- ggplot(data = filter(
  comb, 
  category == "Due Process Complaints (DPC) Total (3)"), 
  aes(x = Year, y = total)) +
  geom_boxplot() + 
  labs(title = "Median Total Due Process Complaints")

# Zoom in on totals of less than 500
p + coord_cartesian(ylim = c(0, 500))
```

```{r}
# TODO Need to find a better way to explore year to year
#ggplot(data = filter(
#  comb,
#  category == "Due Process Complaints (DPC) Total (3)"),
#  aes(x = State, y = total)
#  ) +
#  geom_bar(stat = "identity") +
#  coord_flip() +
#  facet_wrap(~ Year)
```

```{r mediation agreements}
# What is the relationship between mediations held and mediation agreements?
# This looks just at mediations relating to due process hearings.
med <- comb %>%
  filter(
    category == "Mediations Held Related to Due Process Complaints(2.1a)" | 
    category == "Mediation Agreements Related to Due Process Complaints (2.1ai)"
  ) %>%
  spread(key = category, value = total)

med_plot <- ggplot(data = med) +
  geom_point(aes(
    x = `Mediations Held Related to Due Process Complaints(2.1a)`, 
    y = `Mediation Agreements Related to Due Process Complaints (2.1ai)`
  ), 
    position = "jitter",
    alpha = .50) + 
  geom_smooth(aes(
  x = `Mediations Held Related to Due Process Complaints(2.1a)`, 
  y = `Mediation Agreements Related to Due Process Complaints (2.1ai)`
  )) +
  facet_wrap(~ Year) +
  labs(
    title    = "Mediations Held vs. Mediation Agreements",
    subtitle = "Dataset includes only mediations related to due process complaints.",
    x        = "Mediations held relating to due process", 
    y        = "Agreements reached"
    )

# Zoom in on x < 1000 and 6 < 500
med_plot + coord_cartesian(xlim = c(0, 1000), ylim = c(0, 500))
```